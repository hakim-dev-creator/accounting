<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø±ÙˆØ§ØªØ¨ (Enterprise V5.0)</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2563EB">
    <link rel="manifest" href="manifest.json">

    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> 
    
    <style>
        :root {
            --primary: #2563EB; --bg: #F8FAFC; --surface: #FFFFFF; --text: #0F172A; --text-sub: #64748B;
            --border: #E2E8F0; --success: #10B981; --danger: #EF4444; --warning: #F59E0B;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1); --radius: 16px;
        }
        [data-theme="dark"] {
            --bg: #0F172A; --surface: #1E293B; --text: #F8FAFC; --text-sub: #94A3B8;
            --border: #334155; --shadow: 0 4px 6px -1px rgba(0,0,0,0.3);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        body { font-family: 'Tajawal', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; transition: 0.3s; padding-bottom: 80px; }

        /* General */
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .card { background: var(--surface); border-radius: var(--radius); padding: 20px; margin-bottom: 15px; box-shadow: var(--shadow); border: 1px solid var(--border); }
        .btn { width: 100%; padding: 14px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 1rem; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--text); }
        input { width: 100%; padding: 12px; margin-bottom: 10px; background: var(--bg); border: 1px solid var(--border); color: var(--text); border-radius: 10px; font-family: inherit; }

        /* Login */
        #authScreen { position: fixed; inset: 0; background: var(--bg); z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        
        /* Stats */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-card { background: var(--surface); padding: 15px; border-radius: 12px; border: 1px solid var(--border); text-align: center; }
        .stat-val { font-size: 1.4rem; font-weight: 800; color: var(--primary); display: block; }
        .stat-label { font-size: 0.8rem; color: var(--text-sub); }

        /* Calendar */
        .calendar-grid { display: grid; grid-template-columns: 120px repeat(31, 50px); overflow-x: auto; gap: 2px; padding-bottom: 10px; }
        .cal-head, .cal-cell { padding: 10px; text-align: center; border-radius: 8px; font-size: 0.85rem; display: flex; align-items: center; justify-content: center; }
        .cal-head { background: var(--bg); color: var(--text-sub); font-weight: bold; }
        .cal-cell { background: var(--surface); border: 1px solid var(--border); cursor: pointer; }
        .cal-emp { position: sticky; right: 0; background: var(--surface); z-index: 5; border-left: 2px solid var(--primary); font-weight: bold; justify-content: flex-start; padding-right: 10px; }
        .present { background: rgba(16, 185, 129, 0.15); color: var(--success); border-color: var(--success); }
        .absent { background: rgba(239, 68, 68, 0.15); color: var(--danger); border-color: var(--danger); }
        .weekend { background: rgba(245, 158, 11, 0.1); }

        /* Nav */
        .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; background: var(--surface); border-top: 1px solid var(--border); display: flex; justify-content: space-around; padding: 10px; z-index: 1000; box-shadow: 0 -4px 10px rgba(0,0,0,0.05); }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--text-sub); font-size: 0.75rem; background: none; border: none; padding: 5px; }
        .nav-item.active { color: var(--primary); }
        .nav-icon { font-size: 1.4rem; margin-bottom: 2px; }

        /* Header */
        header { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; }
        .app-logo { width: 45px; height: 45px; border-radius: 12px; object-fit: cover; }
        
        /* Modals */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(4px); padding: 20px; }
        .modal-content { background: var(--surface); width: 100%; max-width: 500px; padding: 25px; border-radius: 20px; max-height: 90vh; overflow-y: auto; }
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 6000; left: 50%; bottom: 80px; transform: translateX(-50%); opacity: 0; transition: 0.3s; }
        #toast.show { visibility: visible; opacity: 1; bottom: 90px; }
        
        /* Loading */
        #loader { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loader"><div class="spinner"></div></div>

<div id="authScreen" style="display:none">
    <h2 style="color:var(--primary); margin-bottom:5px">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
    <p style="color:var(--text-sub); margin-bottom:30px">Salary System V5.0</p>
    <input type="email" id="authEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
    <input type="password" id="authPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    <button class="btn btn-primary" onclick="handleLogin()">Ø¯Ø®ÙˆÙ„ ğŸ”’</button>
    <p id="authMsg" style="color:var(--danger); margin-top:15px; font-size:0.9rem"></p>
</div>

<div id="app" style="display:none">
    <div class="container">
        <header>
            <div style="display: flex; align-items: center; gap: 10px;">
                <img id="headerLogo" class="app-logo" src="" style="display:none">
                <div>
                    <div style="font-weight:800; font-size:1.1rem" id="compName">Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</div>
                    <div style="font-size:0.75rem; color:var(--text-sub)">Enterprise System</div>
                </div>
            </div>
            <button class="btn-ghost" style="width:auto; padding:8px" onclick="toggleTheme()">ğŸŒ™</button>
        </header>

        <div id="view-dashboard" class="view">
            <div class="stat-grid">
                <div class="stat-card"><span class="stat-val" id="statTotalSal">0</span><span class="stat-label">Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©</span></div>
                <div class="stat-card"><span class="stat-val" id="statPresent">0</span><span class="stat-label">Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…</span></div>
            </div>
            <div class="card"><canvas id="financeChart"></canvas></div>
        </div>

        <div id="view-calendar" class="view" style="display:none">
            <div class="card" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
                <button class="btn-ghost" style="width:auto" onclick="changeMonth(-1)">â€¹</button>
                <b id="monthLabel" style="font-size:1.1rem"></b>
                <button class="btn-ghost" style="width:auto" onclick="changeMonth(1)">â€º</button>
            </div>
            <div class="card" style="padding:10px; overflow:hidden"><div id="calendarGrid" class="calendar-grid"></div></div>
        </div>

        <div id="view-employees" class="view" style="display:none">
            <div class="card">
                <div style="display:flex; justify-content:space-between; margin-bottom:15px">
                    <h3>ğŸ‘¥ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h3>
                    <button class="btn-primary" style="width:auto; padding:5px 15px" onclick="openEmpModal()">+ Ø¬Ø¯ÙŠØ¯</button>
                </div>
                <div id="empList"></div>
            </div>
        </div>
    </div>

    <nav class="nav-bar">
        <button class="nav-item active" onclick="switchView('dashboard')"><span class="nav-icon">ğŸ“Š</span><span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></button>
        <button class="nav-item" onclick="switchView('calendar')"><span class="nav-icon">ğŸ“…</span><span>Ø§Ù„Ø¯ÙˆØ§Ù…</span></button>
        <button class="nav-item" onclick="switchView('employees')"><span class="nav-icon">ğŸ‘¥</span><span>Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</span></button>
    </nav>
</div>

<div id="empModal" class="modal">
    <div class="modal-content">
        <h3>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù</h3>
        <input id="empName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
        <label style="font-size:0.8rem">Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ (Ø´Ù‡Ø±ÙŠØ§Ù‹)</label>
        <input type="number" id="empBase" placeholder="0">
        <label style="font-size:0.8rem">Ù…Ù†Ø­ (Primes)</label>
        <input type="number" id="empBonus" placeholder="0">
        <label style="font-size:0.8rem">Ø§Ù‚ØªØ·Ø§Ø¹Ø§Øª (Assurance/IRG)</label>
        <input type="number" id="empDeduct" placeholder="0">
        <button class="btn-success" onclick="saveEmployee()">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        <button class="btn-ghost" onclick="closeM('empModal')" style="margin-top:10px">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<div id="attModal" class="modal">
    <div class="modal-content">
        <h3 id="attTitle">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±</h3>
        <div style="display:flex; gap:10px; margin-bottom:10px"><input type="time" id="tIn"> <button class="btn-ghost" style="width:auto" onclick="setNow('tIn')">Ø§Ù„Ø¢Ù†</button></div>
        <div style="display:flex; gap:10px; margin-bottom:20px"><input type="time" id="tOut"> <button class="btn-ghost" style="width:auto" onclick="setNow('tOut')">Ø§Ù„Ø¢Ù†</button></div>
        <button class="btn-primary" onclick="saveAtt('full')">âœ… Ø­ÙØ¸ Ø§Ù„Ø­Ø¶ÙˆØ±</button>
        <button class="btn-danger" style="margin-top:10px" onclick="saveAtt('absent')">âŒ ØªØ³Ø¬ÙŠÙ„ ØºÙŠØ§Ø¨</button>
        <button class="btn-ghost" onclick="closeM('attModal')" style="margin-top:10px">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<div id="toast">ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // âœ…âœ… ØªÙ… Ø¯Ù…Ø¬ ÙƒÙˆØ¯ Ù…Ø´Ø±ÙˆØ¹Ùƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù‡Ù†Ø§ Ø¨Ù†Ø¬Ø§Ø­ âœ…âœ…
    const firebaseConfig = {
        apiKey: "AIzaSyASwJ3qphkvxyu2oF49Wb_9_3jBDwuUOKA",
        authDomain: "salarysystem-e2106.firebaseapp.com",
        projectId: "salarysystem-e2106",
        storageBucket: "salarysystem-e2106.firebasestorage.app",
        messagingSenderId: "544931003926",
        appId: "1:544931003926:web:374f41c92f9c102f5b3f37"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const mainDocRef = doc(db, "salary_system", "main_data");

    let appData = { emps: [], att: {}, companyName: "Ø§Ù„Ù…Ø¤Ø³Ø³Ø©", logo: null };
    let currDate = new Date();
    let sel = null;
    let chartInstance = null;

    // Auth & Loader Logic
    onAuthStateChanged(auth, (user) => {
        // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ù…Ø¬Ø±Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        document.getElementById('loader').style.display = 'none';
        
        if (user) {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            startApp();
        } else {
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('app').style.display = 'none';
        }
    });

    window.handleLogin = () => {
        document.getElementById('loader').style.display = 'flex';
        const e = document.getElementById('authEmail').value;
        const p = document.getElementById('authPass').value;
        signInWithEmailAndPassword(auth, e, p).catch(err => {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('authMsg').innerText = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„: ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±";
        });
    };

    function startApp() {
        onSnapshot(mainDocRef, (docSnap) => {
            if (docSnap.exists()) {
                appData = { ...appData, ...docSnap.data() };
                renderAll(); updateStats();
            } else {
                saveToFirebase();
            }
        });
    }

    async function saveToFirebase() {
        try { await setDoc(mainDocRef, appData); showToast("ØªÙ… Ø§Ù„Ø­ÙØ¸ â˜ï¸"); } catch(e) { showToast("Ø®Ø·Ø£ âŒ"); }
    }

    function renderAll() {
        renderCalendar(); renderEmployees();
        document.getElementById('compName').innerText = appData.companyName;
    }

    function updateStats() {
        let totalSal = 0, present = 0;
        const daysInMonth = new Date(currDate.getFullYear(), currDate.getMonth()+1, 0).getDate();
        
        appData.emps.forEach(e => {
            let monthlyBase = parseFloat(e.baseSalary) || 0;
            let dailyRate = monthlyBase / 30; 
            let workedDays = 0;
            for(let d=1; d<=daysInMonth; d++) {
                let k = `${currDate.getFullYear()}-${currDate.getMonth()}-${d}-${e.id}`;
                if(appData.att[k]?.status === 'full') { workedDays++; if(d === new Date().getDate()) present++; }
            }
            let net = (workedDays * dailyRate) + (parseFloat(e.bonuses)||0) - (parseFloat(e.deductions)||0);
            totalSal += net;
        });

        document.getElementById('statTotalSal').innerText = Math.round(totalSal).toLocaleString() + " Ø¯Ø¬";
        document.getElementById('statPresent').innerText = present;

        const ctx = document.getElementById('financeChart').getContext('2d');
        if(chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Ø§Ù„Ø±ÙˆØ§ØªØ¨', 'Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ'],
                datasets: [{ data: [totalSal, 100000], backgroundColor: ['#2563EB', '#E2E8F0'] }]
            },
            options: { responsive: true, cutout: '70%', plugins: { legend: { display: false } } }
        });
    }

    // Employees
    window.openEmpModal = () => {
        document.getElementById('empName').value = ""; document.getElementById('empBase').value = "";
        document.getElementById('empModal').style.display = "flex";
    };
    window.saveEmployee = () => {
        const n = document.getElementById('empName').value;
        if(n) {
            appData.emps.push({
                id: Date.now(),
                name: n,
                baseSalary: document.getElementById('empBase').value || 0,
                bonuses: document.getElementById('empBonus').value || 0,
                deductions: document.getElementById('empDeduct').value || 0
            });
            saveToFirebase(); closeM('empModal');
        }
    };
    function renderEmployees() {
        document.getElementById('empList').innerHTML = appData.emps.map(e => `
            <div style="display:flex; justify-content:space-between; padding:15px; border-bottom:1px solid var(--border); align-items:center">
                <div><div style="font-weight:bold">${e.name}</div><div style="font-size:0.8rem; color:var(--text-sub)">Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ: ${e.baseSalary}</div></div>
                <button class="btn-danger" style="width:auto; padding:5px 10px" onclick="deleteEmp(${e.id})">Ø­Ø°Ù</button>
            </div>`).join('');
    }
    window.deleteEmp = (id) => { if(confirm("Ø­Ø°ÙØŸ")) { appData.emps = appData.emps.filter(e => e.id !== id); saveToFirebase(); } };

    // Calendar
    window.changeMonth = (n) => { currDate.setMonth(currDate.getMonth() + n); renderCalendar(); };
    function renderCalendar() {
        document.getElementById('monthLabel').innerText = currDate.toLocaleDateString('ar-DZ', { month: 'long', year: 'numeric' });
        const grid = document.getElementById('calendarGrid');
        const days = new Date(currDate.getFullYear(), currDate.getMonth()+1, 0).getDate();
        grid.style.gridTemplateColumns = `120px repeat(${days}, 50px)`;
        
        let html = '<div class="cal-head">Ø§Ù„Ù…ÙˆØ¸Ù</div>';
        for(let d=1; d<=days; d++) {
            let date = new Date(currDate.getFullYear(), currDate.getMonth(), d);
            let isWeekend = (date.getDay() === 5 || date.getDay() === 6);
            html += `<div class="cal-head ${isWeekend?'weekend':''}">${d}</div>`;
        }

        appData.emps.forEach(e => {
            html += `<div class="cal-cell cal-emp">${e.name}</div>`;
            for(let d=1; d<=days; d++) {
                let k = `${currDate.getFullYear()}-${currDate.getMonth()}-${d}-${e.id}`;
                let date = new Date(currDate.getFullYear(), currDate.getMonth(), d);
                let isWeekend = (date.getDay() === 5 || date.getDay() === 6);
                let r = appData.att[k], cls = isWeekend ? 'weekend' : '', txt = '-';
                if(r) { if(r.status === 'full') { cls+=' present'; txt='âœ”'; } else { cls+=' absent'; txt='âœ–'; } }
                html += `<div class="cal-cell ${cls}" onclick="openAttModal('${e.name}', '${k}')">${txt}</div>`;
            }
        });
        grid.innerHTML = html;
    }

    window.openAttModal = (name, key) => { sel = key; document.getElementById('attTitle').innerText = name; document.getElementById('attModal').style.display = 'flex'; };
    window.saveAtt = (status) => {
        let val = { status: status };
        if(status === 'full') { val.tIn = document.getElementById('tIn').value; val.tOut = document.getElementById('tOut').value; }
        appData.att[sel] = val; saveToFirebase(); closeM('attModal');
    };

    window.switchView = (v) => {
        document.querySelectorAll('.view').forEach(el => el.style.display = 'none');
        document.getElementById('view-'+v).style.display = 'block';
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active');
    };
    window.toggleTheme = () => { let b = document.body; b.setAttribute('data-theme', b.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'); };
    window.closeM = (id) => document.getElementById(id).style.display = 'none';
    window.setNow = (id) => { let d = new Date(); document.getElementById(id).value = d.getHours().toString().padStart(2,'0')+":"+d.getMinutes().toString().padStart(2,'0'); };
    function showToast(msg) { let t = document.getElementById('toast'); t.innerText = msg; t.className = "show"; setTimeout(() => t.className = "", 3000); }
</script>
</body>
</html>
