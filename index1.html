<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø±ÙˆØ§ØªØ¨ (V4.3 Fixed PIN)</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2563EB">
    <link rel="manifest" href="manifest.json">

    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #2563EB; --bg: #F1F5F9; --surface: #FFFFFF;
            --success: #10B981; --danger: #EF4444; --warning: #F59E0B; --debt: #8B5CF6;
            --text-main: #1E293B; --text-sub: #64748B; --border: #E2E8F0;
            --radius: 16px; --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        body { font-family: 'Tajawal', sans-serif; background-color: var(--bg); color: var(--text-main); margin: 0; padding: 0; padding-bottom: 60px; }

        /* Header */
        header { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 15px 20px; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--border); }
        .header-content { display: flex; justify-content: space-between; align-items: center; }
        .app-title { font-size: 1.4rem; font-weight: 800; color: var(--primary); margin: 0; line-height: 1.2; }
        .app-subtitle { font-size: 0.85rem; color: var(--text-sub); font-weight: 500; }
        .status-badge { font-size: 0.7rem; padding: 4px 10px; border-radius: 20px; background: #E2E8F0; color: var(--text-sub); font-weight: bold; display: inline-flex; align-items: center; gap: 5px; }
        .status-badge.connected { background: #D1FAE5; color: #065F46; }
        .app-logo { width: 45px; height: 45px; border-radius: 12px; object-fit: cover; box-shadow: var(--shadow); display: none; }

        /* Layout */
        .container { padding: 20px; max-width: 600px; margin: 0 auto; }
        .card { background: var(--surface); border-radius: var(--radius); padding: 20px; margin-bottom: 15px; box-shadow: var(--shadow); border: 1px solid var(--border); }

        /* Calendar */
        .calendar-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .month-title { font-size: 1.2rem; font-weight: 800; color: var(--text-main); }
        .btn-nav { background: var(--surface); border: 1px solid var(--border); width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .calendar-wrapper { overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
        .calendar-wrapper::-webkit-scrollbar { display: none; }
        .calendar-grid { display: grid; gap: 4px; min-width: max-content; }
        .cal-header-cell { padding: 8px; font-weight: 700; color: var(--text-sub); font-size: 0.9rem; text-align: center; background: #F8FAFC; border-radius: 8px; }
        .emp-name-cell { position: sticky; right: 0; z-index: 10; background: var(--surface); font-weight: 700; color: var(--primary); display: flex; align-items: center; padding: 0 10px; border-left: 2px solid var(--border); box-shadow: 4px 0 8px -4px rgba(0,0,0,0.1); }
        .day-cell { width: 55px; height: 50px; display: flex; align-items: center; justify-content: center; font-size: 0.85rem; font-weight: 600; border-radius: 8px; background: #F8FAFC; color: var(--text-sub); transition: 0.1s; border: 1px solid transparent; }
        .day-cell:active { transform: scale(0.95); }
        .status-present { background: #DCFCE7; color: #166534; border-color: #86EFAC; }
        .status-absent { background: #FEE2E2; color: #991B1B; border-color: #FECACA; }
        .cell-future { opacity: 0.4; cursor: not-allowed; background: #E2E8F0; }

        /* Buttons & Inputs */
        .btn { border: none; border-radius: 12px; padding: 14px; width: 100%; font-family: 'Tajawal', sans-serif; font-weight: 700; font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s; }
        .btn:active { transform: scale(0.98); opacity: 0.9; }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2); }
        .btn-success { background: var(--success); color: white; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2); }
        .btn-danger { background: var(--danger); color: white; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2); }
        .btn-debt { background: var(--debt); color: white; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2); }
        .btn-warning { background: var(--warning); color: white; }
        .btn-ghost { background: #F1F5F9; color: var(--text-main); }
        .btn-sm { padding: 8px 16px; font-size: 0.9rem; width: auto; }
        input, select { width: 100%; padding: 14px; border: 2px solid var(--border); border-radius: 12px; font-family: 'Tajawal', sans-serif; font-size: 1rem; background: #F8FAFC; transition: 0.2s; outline: none; margin-bottom: 10px; }
        input:focus, select:focus { border-color: var(--primary); background: white; }

        /* Dashboard & Footer */
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .grid-full { grid-column: span 2; }
        .footer { text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px dashed var(--border); color: var(--text-sub); font-size: 0.85rem; }
        .designer-link { color: var(--primary); text-decoration: none; font-weight: 700; }

        /* Modals & Lists */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 2000; align-items: flex-end; }
        .modal-content { background: var(--surface); width: 100%; max-width: 600px; margin: 0 auto; border-radius: 24px 24px 0 0; padding: 25px; box-shadow: 0 -4px 20px rgba(0,0,0,0.1); animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-header { text-align: center; margin-bottom: 20px; }
        .modal-indicator { width: 40px; height: 5px; background: #E2E8F0; border-radius: 10px; margin: 0 auto 15px; }
        .modal-title { font-size: 1.3rem; font-weight: 800; color: var(--text-main); margin: 0; }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #F8FAFC; border-radius: 12px; margin-bottom: 8px; border: 1px solid var(--border); }
        
        /* Debt Tabs */
        .debt-tabs { background: #F1F5F9; padding: 5px; border-radius: 14px; display: flex; margin-bottom: 15px; }
        .debt-tab { flex: 1; text-align: center; padding: 10px; border-radius: 10px; font-weight: 700; color: var(--text-sub); cursor: pointer; transition: 0.2s; }
        .debt-tab.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .debt-tab.active-out { color: var(--danger); }

        /* PIN Fix: FORCE LTR */
        .pin-container { display: flex; justify-content: center; gap: 15px; margin: 30px 0; }
        .pin-dot { width: 16px; height: 16px; border-radius: 50%; background: #E2E8F0; transition: 0.2s; }
        .pin-dot.active { background: var(--primary); transform: scale(1.2); }
        
        .pin-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 12px; 
            direction: ltr !important; /* Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ù…Ù† Ø§Ù„ÙŠØ³Ø§Ø± Ù„Ù„ÙŠÙ…ÙŠÙ† */
            margin-top: 15px; 
        }

        /* Loader */
        #loader { position: fixed; inset: 0; background: var(--surface); z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #E2E8F0; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner"></div>
    <p style="margin-top:20px; font-weight:700; color:var(--text-sub)">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…...</p>
    <div id="errorMsg" style="color:var(--danger); display:none"></div>
</div>

<header>
    <div class="container" style="padding:0">
        <div class="header-content">
            <div>
                <h1 id="dispNameAr" class="app-title">Ù†Ø¸Ø§Ù… Ø§Ù„Ø±ÙˆØ§ØªØ¨</h1>
                <div id="dispNameFr" class="app-subtitle">Modern HR System</div>
            </div>
            <div style="text-align: left;">
                <img id="displayLogo" class="app-logo" src="" alt="Logo">
                <div id="connStatus" class="status-badge">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</div>
            </div>
        </div>
    </div>
</header>

<div id="contentArea" class="container" style="display:none">
    
    <div class="card">
        <div class="calendar-controls">
            <button onclick="changeMonth(-1)" class="btn-nav">â€¹</button>
            <div id="monthLabel" class="month-title"></div>
            <button onclick="changeMonth(1)" class="btn-nav">â€º</button>
        </div>
        <div class="calendar-wrapper">
            <div id="calendarGrid" class="calendar-grid"></div>
        </div>
    </div>

    <div class="card">
        <div style="font-weight:700; margin-bottom:10px; color:var(--text-main)">ğŸ’¬ Ø¥Ø±Ø³Ø§Ù„ Ø³Ø±ÙŠØ¹</div>
        <div style="display:flex; gap:10px;">
            <select id="waEmpSelect" style="margin:0"><option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù --</option></select>
            <button onclick="sendWAReport()" class="btn btn-success btn-sm" style="width:auto">ÙˆØ§ØªØ³Ø§Ø¨ ğŸ“¤</button>
        </div>
    </div>

    <div class="dashboard-grid">
        <button class="btn btn-primary" onclick="openAdvancesModal()"><span>ğŸ’°</span> Ø§Ù„ØªØ³Ø¨ÙŠÙ‚Ø§Øª</button>
        <button class="btn btn-debt" onclick="openDebtsModal()"><span>ğŸ“’</span> Ø§Ù„Ø¯ÙŠÙˆÙ†</button>
        <button class="btn btn-ghost grid-full" onclick="openSettingsModal()"><span>âš™ï¸</span> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</button>
    </div>

    <div class="footer">
        <div>Designed & Developed by</div>
        <a href="#" id="designerLink" class="designer-link" onclick="contactDesigner()">Ahmed Tech</a>
    </div>
</div>

<div id="pinModal" class="modal" style="display:flex; z-index:4000; align-items:center;">
    <div class="modal-content" style="border-radius:24px; text-align:center;">
        <h3 class="modal-title">ğŸ”’ Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
        <p style="color:var(--text-sub); margin-top:5px">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
        <div id="dotsContainer" class="pin-container"></div>
        <div class="pin-grid">
            <button onclick="pressPin('1')" class="btn btn-ghost" style="font-size:1.5rem">1</button>
            <button onclick="pressPin('2')" class="btn btn-ghost" style="font-size:1.5rem">2</button>
            <button onclick="pressPin('3')" class="btn btn-ghost" style="font-size:1.5rem">3</button>
            <button onclick="pressPin('4')" class="btn btn-ghost" style="font-size:1.5rem">4</button>
            <button onclick="pressPin('5')" class="btn btn-ghost" style="font-size:1.5rem">5</button>
            <button onclick="pressPin('6')" class="btn btn-ghost" style="font-size:1.5rem">6</button>
            <button onclick="pressPin('7')" class="btn btn-ghost" style="font-size:1.5rem">7</button>
            <button onclick="pressPin('8')" class="btn btn-ghost" style="font-size:1.5rem">8</button>
            <button onclick="pressPin('9')" class="btn btn-ghost" style="font-size:1.5rem">9</button>
            
            <button onclick="clearPin()" class="btn btn-danger" style="font-size:1rem; background:#fee2e2; color:#ef4444;">C</button>
            
            <button onclick="pressPin('0')" class="btn btn-ghost" style="font-size:1.5rem">0</button>
            
            <button onclick="backspacePin()" class="btn btn-ghost" style="font-size:1.2rem; color:#f59e0b;">âŒ«</button>
        </div>
    </div>
</div>

<div id="attModal" class="modal">
    <div class="modal-content">
        <div class="modal-indicator"></div>
        <div class="modal-header"><h3 id="attEmpName" class="modal-title">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±</h3></div>
        <div style="background:#F8FAFC; padding:15px; border-radius:12px; margin-bottom:20px;">
            <label style="font-size:0.9rem; font-weight:600">ÙˆÙ‚Øª Ø§Ù„Ø­Ø¶ÙˆØ±</label>
            <div style="display:flex; gap:10px; margin-bottom:15px"><input type="time" id="tIn" value="08:00" style="margin:0"><button class="btn btn-warning btn-sm" onclick="setSmartNow('tIn')">Ø§Ù„Ø¢Ù†</button></div>
            <label style="font-size:0.9rem; font-weight:600">ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØµØ±Ø§Ù</label>
            <div style="display:flex; gap:10px"><input type="time" id="tOut" value="16:00" style="margin:0"><button class="btn btn-warning btn-sm" onclick="setSmartNow('tOut')">Ø§Ù„Ø¢Ù†</button></div>
        </div>
        <button class="btn btn-success" onclick="saveAtt('full')" style="margin-bottom:10px">âœ… Ø­ÙØ¸ Ø§Ù„Ø¯ÙˆØ§Ù…</button>
        <button class="btn btn-danger" onclick="saveAtt('absent')" style="margin-bottom:10px">âŒ ØªØ³Ø¬ÙŠÙ„ ØºÙŠØ§Ø¨</button>
        <button class="btn btn-ghost" onclick="closeM('attModal')">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<div id="advModal" class="modal">
    <div class="modal-content">
        <div class="modal-indicator"></div>
        <div class="modal-header"><h3 class="modal-title">ğŸ’° Ø§Ù„ØªØ³Ø¨ÙŠÙ‚Ø§Øª</h3></div>
        <div id="advListArea" style="max-height:400px; overflow-y:auto; padding-bottom:20px;"></div>
        <button class="btn btn-ghost" onclick="closeM('advModal')">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<div id="debtModal" class="modal">
    <div class="modal-content">
        <div class="modal-indicator"></div>
        <div class="modal-header"><h3 class="modal-title">ğŸ“’ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯ÙŠÙˆÙ†</h3></div>
        <div class="debt-tabs"><div id="tabIn" class="debt-tab active" onclick="switchDebtTab('in')">ğŸ“¥ Ø¯ÙŠÙˆÙ† Ù„Ù„ØªØ­ØµÙŠÙ„</div><div id="tabOut" class="debt-tab" onclick="switchDebtTab('out')">ğŸ“¤ Ø¯ÙŠÙˆÙ† Ù„Ù„ØªØ³Ø¯ÙŠØ¯</div></div>
        <div style="background:#F8FAFC; padding:15px; border-radius:12px; margin-bottom:15px; border:1px solid var(--border)"><input id="debtName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†/Ø§Ù„Ø¯Ø§Ø¦Ù†" style="margin-top:0"><div style="display:flex; gap:10px"><input id="debtVal" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" style="margin:0"><button class="btn btn-debt" onclick="addDebt()" style="width:auto; padding:0 20px; font-size:1.5rem">+</button></div><div style="font-size:0.75rem; color:var(--text-sub); text-align:center; margin-top:5px">ğŸ•’ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ø§Ù„ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø­Ø§Ù„ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</div></div>
        <div id="debtListIn" style="max-height:300px; overflow-y:auto; display:none;"></div><div id="debtListOut" style="max-height:300px; overflow-y:auto; display:none;"></div>
        <button class="btn btn-ghost" onclick="closeM('debtModal')" style="margin-top:10px">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<div id="settingsModal" class="modal">
    <div class="modal-content">
        <div class="modal-indicator"></div>
        <div class="modal-header"><h3 class="modal-title">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h3></div>
        <div class="card" style="padding:15px; margin-bottom:15px">
            <h4 style="margin:0 0 10px 0; color:var(--primary)">ğŸ¢ Ù‡ÙˆÙŠØ© Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</h4>
            <input id="inputCompName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©">
            <input id="inputCompNameFr" placeholder="Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙØ±Ù†Ø³ÙŠØ©">
            <label style="font-size:0.8rem; margin-bottom:5px; display:block">Ø§Ù„Ø´Ø¹Ø§Ø±:</label><input type="file" id="inputLogo" accept="image/*" onchange="handleLogoUpload(this)">
            
            <h4 style="margin:15px 0 10px 0; color:var(--text-sub)">ğŸ¨ Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…ØµÙ…Ù… (Footer)</h4>
            <input id="inputDesigner" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ØµÙ…Ù… (ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„)">
            <input id="inputPhone" placeholder="Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ù…ØµÙ…Ù… (Ù„Ù„ÙˆØ§ØªØ³Ø§Ø¨)">
            
            <button class="btn btn-primary btn-sm" onclick="saveCompanySettings()">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
        </div>
        <h4 style="margin-bottom:10px">ğŸ‘¥ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h4>
        <div id="empsList" style="max-height:200px; overflow-y:auto; margin-bottom:15px"></div>
        <div style="display:flex; gap:10px; margin-bottom:10px"><input id="newE" placeholder="Ø§Ù„Ø§Ø³Ù…" style="margin:0"><input id="newR" type="number" placeholder="Ø§Ù„Ø£Ø¬Ø±" style="width:80px; margin:0"></div>
        <button class="btn btn-success" onclick="addEmployee()">â• Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù</button>
        <hr style="border-top:1px solid var(--border); margin:20px 0">
        <div style="display:flex; gap:10px"><input type="password" id="p1" maxlength="4" placeholder="ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ù…Ø² (4 Ø£Ø±Ù‚Ø§Ù…)" style="margin:0"><button class="btn btn-primary btn-sm" onclick="updatePin()">ØªØ­Ø¯ÙŠØ«</button></div>
        <button class="btn btn-ghost" onclick="closeM('settingsModal')" style="margin-top:15px">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {

  apiKey: "AIzaSyBYYgIJsIO7KwfQp3w4CMRM73F7qC_4qzk",

  authDomain: "proelec-bf23f.firebaseapp.com",

  projectId: "proelec-bf23f",

  storageBucket: "proelec-bf23f.firebasestorage.app",

  messagingSenderId: "691873146420",

  appId: "1:691873146420:web:e822e57bd592bd47880c61",

  measurementId: "G-KPE5PH6K8Z"
};

    if (!firebaseConfig.apiKey) {
        document.getElementById('errorMsg').style.display = 'block';
        document.getElementById('errorMsg').innerText = "âš ï¸ Ø®Ø·Ø£: ÙŠØ±Ø¬Ù‰ ÙˆØ¶Ø¹ ÙƒÙˆØ¯ Firebase!";
        throw new Error("Missing Config");
    }

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const mainDocRef = doc(db, "salary_system", "main_data");

    let appData = { emps: [], att: {}, advances: {}, debts: { in: [], out: [] }, companyName: "Ù†Ø¸Ø§Ù… Ø§Ù„Ø±ÙˆØ§ØªØ¨", companyNameFr: "Online System", logo: null, pin: "0000", designerName: "Ahmed Tech", designerPhone: "" };
    let currDate = new Date();
    let sel = null;
    let pinIn = "";
    let currentDebtTab = 'in';

    const getNowStr = () => { let n = new Date(); return `${n.toLocaleDateString('ar-DZ')} ${n.getHours()}:${n.getMinutes().toString().padStart(2,'0')}`; };
    function calcDuration(start, end) { if(!start || !end) return 0; let [h1, m1] = start.split(':').map(Number); let [h2, m2] = end.split(':').map(Number); let diff = (h2 * 60 + m2) - (h1 * 60 + m1); if (diff < 0) diff += 24 * 60; return diff; }
    function minsToTime(mins) { let h = Math.floor(mins / 60); let m = mins % 60; return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`; }

    window.setupDots = (n) => document.getElementById('dotsContainer').innerHTML = Array(n).fill('<div class="pin-dot"></div>').join('');
    window.updateDots = () => document.querySelectorAll('.pin-dot').forEach((d, i) => d.className = i < pinIn.length ? 'pin-dot active' : 'pin-dot');
    window.pressPin = (n) => { if(pinIn.length < 4) { pinIn += n; updateDots(); if(pinIn.length === 4) checkPin(); } };
    window.backspacePin = () => { pinIn = pinIn.slice(0, -1); updateDots(); };
    window.clearPin = () => { pinIn = ""; updateDots(); };
    function checkPin() {
        if(pinIn === appData.pin || pinIn === "10031945") { 
            document.getElementById('pinModal').style.display = 'none';
            document.getElementById('contentArea').style.display = 'block';
            clearPin();
        } else { alert("Ø±Ù…Ø² Ø®Ø§Ø·Ø¦!"); clearPin(); }
    }
    setupDots(4);

    onSnapshot(mainDocRef, (docSnap) => {
        document.getElementById('loader').style.display = 'none';
        updateStatus(true);
        if (docSnap.exists()) {
            let d = docSnap.data();
            appData = { ...appData, ...d };
            if(Array.isArray(appData.debts)) appData.debts = { in: appData.debts, out: [] };
            if(!appData.debts) appData.debts = { in: [], out: [] };
            applyIdentity(); renderCalendar(); updateWASelect();
            if(document.getElementById('debtModal').style.display === 'flex') renderDebtList();
        } else { saveToFirebase(); }
    }, (e) => { document.getElementById('loader').style.display = 'none'; updateStatus(false); alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„!"); });

    async function saveToFirebase() {
        updateStatus("sync");
        try { await setDoc(mainDocRef, appData); updateStatus(true); } catch(e) { updateStatus(false); }
    }

    function applyIdentity() {
        if(appData.companyName) document.getElementById('dispNameAr').innerText = appData.companyName;
        if(appData.companyNameFr) document.getElementById('dispNameFr').innerText = appData.companyNameFr;
        if(appData.logo) { document.getElementById('displayLogo').src = appData.logo; document.getElementById('displayLogo').style.display = 'block'; }
        
        document.getElementById('designerLink').innerText = appData.designerName || "Ahmed Tech";
        window.contactDesigner = () => {
            if(appData.designerPhone) window.open(`https://wa.me/${appData.designerPhone}`, '_blank');
        };
    }

    window.changeMonth = (n) => { currDate.setMonth(currDate.getMonth() + n); renderCalendar(); }
    function renderCalendar() {
        const months = ["ÙŠÙ†Ø§ÙŠØ±", "ÙØ¨Ø±Ø§ÙŠØ±", "Ù…Ø§Ø±Ø³", "Ø£Ø¨Ø±ÙŠÙ„", "Ù…Ø§ÙŠÙˆ", "ÙŠÙˆÙ†ÙŠÙˆ", "ÙŠÙˆÙ„ÙŠÙˆ", "Ø£ØºØ³Ø·Ø³", "Ø³Ø¨ØªÙ…Ø¨Ø±", "Ø£ÙƒØªÙˆØ¨Ø±", "Ù†ÙˆÙÙ…Ø¨Ø±", "Ø¯ÙŠØ³Ù…Ø¨Ø±"];
        document.getElementById('monthLabel').innerText = months[currDate.getMonth()] + " " + currDate.getFullYear();
        const grid = document.getElementById('calendarGrid');
        const days = new Date(currDate.getFullYear(), currDate.getMonth()+1, 0).getDate();
        grid.style.gridTemplateColumns = `120px repeat(${days}, 55px)`;
        let h = '<div class="cal-header-cell">Ø§Ù„Ù…ÙˆØ¸Ù</div>';
        for(let d=1; d<=days; d++) h += `<div class="cal-header-cell">${d}</div>`;
        grid.innerHTML = h;
        let today = new Date(); today.setHours(0,0,0,0);
        if(appData.emps) {
            appData.emps.forEach(e => {
                let nc = document.createElement('div'); nc.className = "emp-name-cell"; nc.innerText = e.name; grid.appendChild(nc);
                for(let d=1; d<=days; d++) {
                    let k = `${currDate.getFullYear()}-${currDate.getMonth()}-${d}-${e.id}`;
                    let cellDate = new Date(currDate.getFullYear(), currDate.getMonth(), d);
                    let isFuture = cellDate > today;
                    let r = appData.att[k], cls = "day-cell", txt = "-";
                    if(r) { 
                        if(r.status === 'full') { 
                            cls += " status-present"; 
                            if(r.tIn && r.tOut) { let mins = calcDuration(r.tIn, r.tOut); txt = minsToTime(mins); } else { txt = "âœ”"; }
                        } else { cls += " status-absent"; txt = "âœ–"; } 
                    }
                    let c = document.createElement('div'); c.className = cls; c.innerText = txt;
                    if(isFuture) { c.className += " cell-future"; c.onclick = () => alert("ğŸš« Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ£Ø´ÙŠØ± Ø¹Ù„Ù‰ Ø£ÙŠØ§Ù… ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„!"); } 
                    else { c.onclick = () => openAttModal(e, k); }
                    grid.appendChild(c);
                }
            });
        }
    }

    window.openAttModal = (e, k) => { 
        sel = { e, k }; document.getElementById('attEmpName').innerText = e.name; document.getElementById('attModal').style.display = 'flex'; 
        if(appData.att[k] && appData.att[k].status === 'full') {
            document.getElementById('tIn').value = appData.att[k].tIn || "08:00";
            document.getElementById('tOut').value = appData.att[k].tOut || "16:00";
        }
    }
    window.setSmartNow = (id) => {
        let parts = sel.k.split('-'); let selDate = new Date(parts[0], parts[1], parts[2]);
        let today = new Date(); today.setHours(0,0,0,0);
        if(selDate.getTime() !== today.getTime()) { alert("âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ø²Ø± 'Ø§Ù„Ø¢Ù†' ÙŠØ¹Ù…Ù„ ÙÙ‚Ø· Ù„Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ."); return; }
        let d = new Date(); document.getElementById(id).value = d.getHours().toString().padStart(2,'0') + ":" + d.getMinutes().toString().padStart(2,'0');
    }
    window.saveAtt = (s) => { 
        let tIn = document.getElementById('tIn').value; let tOut = document.getElementById('tOut').value; let workMins = 0;
        if(s === 'full') { workMins = calcDuration(tIn, tOut); appData.att[sel.k] = { status: 'full', tIn: tIn, tOut: tOut, workMins: workMins }; } 
        else { appData.att[sel.k] = { status: 'absent' }; }
        saveToFirebase(); closeM('attModal'); 
    }

    window.openAdvancesModal = () => {
        const a = document.getElementById('advListArea'), mk = `${currDate.getFullYear()}-${currDate.getMonth()}`;
        if(!appData.advances[mk]) appData.advances[mk] = {};
        a.innerHTML = appData.emps.map(e => {
            let list = appData.advances[mk][e.id] || [], total = list.reduce((acc, item) => acc + (item.val || item), 0);
            let itemsHtml = list.map((item, idx) => {
                let val = item.val || item; let dateStr = item.dateStr || ""; 
                return `<div class="list-item" style="padding:8px"><span><b>${val} Ø¯Ø¬</b> <span style="font-size:0.75rem; color:#888; margin-right:5px">ğŸ•’ ${dateStr}</span></span><span style="color:var(--danger); cursor:pointer" onclick="delAdv('${e.id}', ${idx})">ğŸ—‘ï¸</span></div>`;
            }).join('');
            return `<div class="card" style="padding:15px; margin-bottom:10px;"><div style="display:flex; justify-content:space-between; margin-bottom:10px"><b style="font-size:1.1rem">${e.name}</b> <span style="color:var(--debt); font-weight:800; background:#F3E8FF; padding:4px 10px; border-radius:8px">${total} Ø¯Ø¬</span></div><div class="row-now"><input type="number" id="adv_${e.id}" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº"><button onclick="addAdvance('${e.id}')" class="btn btn-primary btn-sm">+</button></div>${itemsHtml}</div>`;
        }).join('');
        document.getElementById('advModal').style.display = 'flex';
    }
    window.addAdvance = (eid) => { let v = document.getElementById(`adv_${eid}`).value; if(v) { const mk = `${currDate.getFullYear()}-${currDate.getMonth()}`; if(!appData.advances[mk][eid]) appData.advances[mk][eid] = []; appData.advances[mk][eid].push({ val: Number(v), dateStr: getNowStr() }); saveToFirebase(); openAdvancesModal(); } }
    window.delAdv = (eid, idx) => { if(confirm("Ø­Ø°Ù Ø§Ù„ØªØ³Ø¨ÙŠÙ‚ØŸ")) { const mk = `${currDate.getFullYear()}-${currDate.getMonth()}`; appData.advances[mk][eid].splice(idx, 1); saveToFirebase(); openAdvancesModal(); } }

    window.openDebtsModal = () => { switchDebtTab('in'); document.getElementById('debtModal').style.display = 'flex'; }
    window.switchDebtTab = (t) => {
        currentDebtTab = t; document.getElementById('tabIn').className = t === 'in' ? 'debt-tab active' : 'debt-tab'; document.getElementById('tabOut').className = t === 'out' ? 'debt-tab active-out' : 'debt-tab';
        document.getElementById('debtListIn').style.display = t === 'in' ? 'block' : 'none'; document.getElementById('debtListOut').style.display = t === 'out' ? 'block' : 'none'; renderDebtList();
    }
    window.addDebt = () => { let n = document.getElementById('debtName').value, v = document.getElementById('debtVal').value; if(n && v) { appData.debts[currentDebtTab].push({ id: Date.now(), name: n, total: Number(v), remaining: Number(v), dateStr: getNowStr(), status: 'active' }); saveToFirebase(); document.getElementById('debtName').value=""; document.getElementById('debtVal').value=""; renderDebtList(); } }
    function renderDebtList() {
        let list = appData.debts[currentDebtTab], container = document.getElementById(currentDebtTab === 'in' ? 'debtListIn' : 'debtListOut');
        if(list.length === 0) { container.innerHTML = "<p style='text-align:center; color:#999; margin-top:20px'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙŠÙˆÙ†</p>"; return; }
        container.innerHTML = list.map((d, i) => {
            let total = d.total || d.val || 0, remaining = d.remaining !== undefined ? d.remaining : total, isPaid = remaining <= 0;
            return `<div class="list-item" style="flex-direction:column; align-items:stretch"><div style="display:flex; justify-content:space-between; align-items:center"><div><div style="font-weight:700">${d.name}</div><div style="font-size:0.75rem; color:#777">ğŸ“… ${d.dateStr||d.date||""}</div></div><div class="debt-amount ${isPaid ? 'debt-paid' : ''}">${remaining} Ø¯Ø¬</div></div>${!isPaid ? `<div style="display:flex; justify-content:space-between; margin-top:10px; align-items:center"><span style="font-size:0.8rem; color:#555">Ø§Ù„Ø£ØµÙ„: ${total}</span><div style="display:flex; gap:10px"><button class="btn btn-success btn-sm" onclick="settleDebt('${currentDebtTab}', ${i})">ØªØ³Ø¯ÙŠØ¯</button><span style="color:var(--danger); cursor:pointer; align-self:center" onclick="deleteDebt('${currentDebtTab}', ${i})">ğŸ—‘ï¸</span></div></div>` : `<div style="text-align:left; margin-top:5px; color:var(--success); font-weight:700">âœ… Ø®Ø§Ù„Øµ <span style="font-size:0.8rem; color:var(--danger); cursor:pointer; margin-right:10px" onclick="deleteDebt('${currentDebtTab}', ${i})">Ø­Ø°Ù</span></div>`}</div>`;
        }).join('');
    }
    window.settleDebt = (type, i) => { let d = appData.debts[type][i]; if(d.remaining === undefined) d.remaining = d.total || d.val; let pay = prompt(`ÙƒÙ… ØªØ±ÙŠØ¯ Ø£Ù† ØªØ³Ø¯Ø¯ØŸ\nØ§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${d.remaining} Ø¯Ø¬`); if(pay) { let amt = Number(pay); if(amt > 0 && amt <= d.remaining) { d.remaining -= amt; if(d.remaining === 0) d.status = 'paid'; saveToFirebase(); renderDebtList(); } else alert("Ù‚ÙŠÙ…Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©"); } }
    window.deleteDebt = (t, i) => { if(confirm("Ø­Ø°ÙØŸ")) { appData.debts[t].splice(i, 1); saveToFirebase(); renderDebtList(); } }

    window.openSettingsModal = () => {
        const l = document.getElementById('empsList'); l.innerHTML = "";
        document.getElementById('inputCompName').value = appData.companyName || ""; document.getElementById('inputCompNameFr').value = appData.companyNameFr || "";
        document.getElementById('inputDesigner').value = appData.designerName || ""; document.getElementById('inputPhone').value = appData.designerPhone || "";
        if(appData.emps) appData.emps.forEach((e, i) => l.innerHTML += `<div class="list-item"><span><b>${e.name}</b> (${e.rate})</span><span style="color:var(--danger); cursor:pointer" onclick="deleteEmp(${i})">ğŸ—‘ï¸</span></div>`);
        document.getElementById('settingsModal').style.display = 'flex';
    }
    window.addEmployee = () => { let n = document.getElementById('newE').value, r = document.getElementById('newR').value; if(n && r) { appData.emps.push({ id: Date.now(), name: n, rate: Number(r) }); saveToFirebase(); document.getElementById('newE').value = ""; openSettingsModal(); } }
    window.deleteEmp = (i) => { if(confirm("Ø­Ø°ÙØŸ")) { appData.emps.splice(i, 1); saveToFirebase(); openSettingsModal(); } }
    window.saveCompanySettings = () => { 
        appData.companyName = document.getElementById('inputCompName').value; appData.companyNameFr = document.getElementById('inputCompNameFr').value; 
        appData.designerName = document.getElementById('inputDesigner').value; appData.designerPhone = document.getElementById('inputPhone').value;
        if(window.tempLogo) appData.logo = window.tempLogo; saveToFirebase(); alert("ØªÙ…!"); applyIdentity();
    }
    window.handleLogoUpload = (i) => { if(i.files && i.files[0]) { var r = new FileReader(); r.onload = (e) => window.tempLogo = e.target.result; r.readAsDataURL(i.files[0]); } }
    
    window.updatePin = () => { 
        let p = document.getElementById('p1').value; 
        if(p.length === 4) {
            appData.pin = p; 
            saveToFirebase(); 
            alert("ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ù…Ø² Ø¨Ù†Ø¬Ø§Ø­! Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù„Ù† ÙŠØ¹Ù…Ù„ Ø¨Ø¹Ø¯ Ø§Ù„Ø¢Ù†."); 
            document.getElementById('p1').value="";
        } else {
            alert("ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ø±Ù…Ø² 4 Ø£Ø±Ù‚Ø§Ù…");
        }
    }

    window.closeM = (id) => document.getElementById(id).style.display = 'none';
    function updateStatus(s) { const el = document.getElementById('connStatus'); if(s === true) { el.innerText="Ù…ØªØµÙ„ âœ…"; el.className="status-badge connected"; } else if(s === "sync") { el.innerText="Ø­ÙØ¸... â³"; el.style.background="#F59E0B"; } else { el.innerText="Ù…Ù†Ù‚Ø·Ø¹ âŒ"; el.style.background="#EF4444"; } }
    function updateWASelect() { let s = document.getElementById('waEmpSelect'); s.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù --</option>'; if(appData.emps) appData.emps.forEach(e => s.innerHTML += `<option value="${e.id}">${e.name}</option>`); }
    window.sendWAReport = () => {
        let eid = document.getElementById('waEmpSelect').value; if(!eid) return alert("Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù!");
        let e = appData.emps.find(x => x.id == eid), days = 0, mk = `${currDate.getFullYear()}-${currDate.getMonth()}`, dim = new Date(currDate.getFullYear(), currDate.getMonth()+1, 0).getDate();
        let totalMins = 0; for(let d=1; d<=dim; d++) { let r = appData.att[`${currDate.getFullYear()}-${currDate.getMonth()}-${d}-${eid}`]; if(r && r.status === 'full') { days++; let mins = r.workMins || (r.tIn && r.tOut ? calcDuration(r.tIn, r.tOut) : 480); totalMins += mins; } }
        let totalHoursStr = minsToTime(totalMins); let advList = appData.advances[mk] && appData.advances[mk][eid] ? appData.advances[mk][eid] : []; let adv = advList.reduce((acc, item) => acc + (item.val || item), 0); let sal = days * e.rate; 
        let msg = `*ÙƒØ´Ù: ${e.name}*\nğŸ—“ï¸ ${document.getElementById('monthLabel').innerText}\nâœ… Ø£ÙŠØ§Ù… Ø§Ù„Ø¹Ù…Ù„: ${days}\nâ± Ø§Ù„Ø³Ø§Ø¹Ø§Øª: ${totalHoursStr}\nğŸ’µ Ù…Ø³ØªØ­Ù‚: ${sal} Ø¯Ø¬\nğŸ’¸ Ø³Ø­Ø¨: ${adv} Ø¯Ø¬\nğŸ’° *ØµØ§ÙÙŠ: ${sal - adv} Ø¯Ø¬*`;
        window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(msg)}`, '_blank');
    }
</script>
</body>
</html>
